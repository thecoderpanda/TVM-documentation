1. 4.5. Exception handling
1. 4.5.1. Two arguments of the exception handler: exception param-
eter and exception number. Every exception is characterized by two
arguments: the exception number (an Integer) and the exception parameter
(any value, most often a zero Integer). Exception numbers 0–31 are reserved
for TVM, while all other exception numbers are available for user-defined
exceptions.
1. 4.5.2. Primitives for throwing an exception. There are several spe-
cial primitives used for throwing an exception. The most general of them,
THROWANY, takes two arguments, v and 0 ≤ n < 216, from the stack, and
throws the exception with number n and value v. There are variants of
this primitive that assume v to be a zero integer, store n as a literal value,
and/orareconditionalonanintegervaluetakenfromthestack. User-defined
exceptions may use arbitrary values as v (e.g., trees of cells) if needed.
1. 4.5.3. Exceptions generated by TVM. Of course, some exceptions are
generated by normal primitives. For example, an arithmetic overflow excep-
tion is generated whenever the result of an arithmetic operation does not fit
into a signed 257-bit integer. In such cases, the arguments of the exception,
v and n, are determined by TVM itself.
1. 4.5.4. Exception handling. The exception handling itself consists in a
control transfer to the exception handler—i.e., the continuation specified in
control register c2, with v and n supplied as the two arguments to this
continuation, as if a JMP to c2 had been requested with n(cid:48)(cid:48) = 2 arguments
(cf. 4.1.7 and 4.1.6). As a consequence, v and n end up in the top of the
stack of the exception handler. The remainder of the old stack is discarded.
Notice that if the continuation in c2 has a value for c2 in its savelist, it
will be used to set up the new value of c2 before executing the exception
handler. In particular, if the exception handler invokes THROWANY, it will re-
throw the original exception with the restored value of c2. This trick enables
the exception handler to handle only some exceptions, and pass the rest to
an outer exception handler.
1. 4.5.5. Default exception handler. When an instance of TVM is created,
c2containsareferencetothe“defaultexceptionhandlercontinuation”, which
is an ec_fatal extraordinary continuation (cf. 4.1.5). Its execution leads
to the termination of the execution of TVM, with the arguments v and n
of the exception returned to the outside caller. In the context of the TON
Blockchain, n will be stored as a part of the transaction’s result.
59

